<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Rotas e Colaboradores</title>
    
    <!-- Folium/Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- Bootstrap para melhorar a interface -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        
        .card-header {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: bold;
        }
        
        #map {
            height: 600px;
            border-radius: 0 0 10px 10px;
            z-index: 1;
        }
        
        .loading {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 10;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .table-responsive {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 50%;
        }
        
        .blue-line {
            background-color: blue;
        }
        
        .green-marker {
            background-color: #4CAF50;
        }
        
        .cluster-marker {
            background-color: #FF9800;
        }
    </style>
</head>
<body>
    <div class="header text-center">
        <div class="container">
            <h1><i class="fas fa-map-marked-alt"></i> Visualizador de Rotas e Colaboradores</h1>
            <p class="lead">Visualize rotas a partir de arquivos KML e localize colaboradores no mapa</p>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-cogs"></i> Controles
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="turno" class="form-label"><i class="fas fa-clock"></i> Turno:</label>
                            <select id="turno" class="form-select">
                                <option value="">Carregando turnos...</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="rota" class="form-label"><i class="fas fa-route"></i> Rota:</label>
                            <select id="rota" class="form-select" disabled>
                                <option value="">Selecione um turno primeiro</option>
                            </select>
                        </div>
                        
                        <button id="gerar-mapa" class="btn btn-success w-100" disabled>
                            <i class="fas fa-map"></i> Gerar Mapa
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-info-circle"></i> Status
                    </div>
                    <div class="card-body">
                        <div id="status">Pronto para carregar dados. Selecione um turno e uma rota.</div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-map"></i> Mapa
                    </div>
                    <div class="position-relative">
                        <div class="loading" id="loading">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-2">Carregando dados...</p>
                        </div>
                        <div id="map"></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-users"></i> Colaboradores
                    </div>
                    <div class="card-body">
                        <div id="tabela-colaboradores">
                            <p class="text-center text-muted">Nenhum colaborador carregado ainda.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="legend">
        <h6>Legenda</h6>
        <div class="legend-item">
            <div class="legend-color blue-line"></div>
            <span>Rota (KML)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color green-marker"></div>
            <span>Colaborador</span>
        </div>
        <div class="legend-item">
            <div class="legend-color cluster-marker"></div>
            <span>Agrupamento</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <script>
        // Configurações
        const USER = "LevyCS07";
        const REPO = "kml-rotas";
        const BRANCH = "main";
        const BASE_URL = `https://raw.githubusercontent.com/${USER}/${REPO}/${BRANCH}/`;
        
        // Elementos DOM
        const turnoSelect = document.getElementById('turno');
        const rotaSelect = document.getElementById('rota');
        const gerarMapaBtn = document.getElementById('gerar-mapa');
        const loadingDiv = document.getElementById('loading');
        const statusDiv = document.getElementById('status');
        const tabelaColaboradores = document.getElementById('tabela-colaboradores');
        const mapDiv = document.getElementById('map');
        
        // Variáveis globais
        let map = null;
        let turnosData = {};
        let currentLayers = [];
        let markerCluster = null;
        let colaboradoresData = [];
        let colaboradoresBounds = null;

        // Inicialização
        document.addEventListener('DOMContentLoaded', async () => {
            await inicializarAplicacao();
        });

        // Função para inicializar a aplicação
        async function inicializarAplicacao() {
            mostrarLoading(true, 'Carregando dados...');
            
            try {
                // Inicializar mapa
                inicializarMapa();
                
                // Carregar dados de colaboradores
                await carregarColaboradoresCSV();
                
                // Carregar dados de turnos
                turnosData = await listarTurnosGitHub();
                
                // Popular dropdown de turnos
                popularSelect(turnoSelect, Object.keys(turnosData));
                
                // Configurar event listeners
                turnoSelect.addEventListener('change', atualizarRotasDropdown);
                gerarMapaBtn.addEventListener('click', gerarMapa);
                
                mostrarStatus('Selecione um turno e uma rota para visualizar no mapa');
            } catch (error) {
                console.error('Erro na inicialização:', error);
                mostrarStatus('Erro ao carregar dados. Verifique o console para detalhes.', 'error');
            } finally {
                mostrarLoading(false);
            }
        }

        // Função para carregar dados de colaboradores do CSV
        async function carregarColaboradoresCSV() {
            return new Promise((resolve, reject) => {
                Papa.parse("COORDENADAS.csv", {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.data && results.data.length > 0) {
                            colaboradoresData = results.data;
                            console.log("Dados de colaboradores carregados:", colaboradoresData.length, "registros");
                            resolve(colaboradoresData);
                        } else {
                            reject(new Error("Nenhum dado encontrado no CSV"));
                        }
                    },
                    error: function(error) {
                        reject(error);
                    }
                });
            });
        }

        // Função para inicializar o mapa
        function inicializarMapa() {
            map = L.map('map').setView([-3.119, -60.021], 12);
            
            // Adicionar camada base do OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Adicionar controle de camadas
            L.control.scale({metric: true, imperial: false}).addTo(map);
            
            // Inicializar bounds para colaboradores
            colaboradoresBounds = L.latLngBounds();
        }

        // Função para converter coordenadas com vírgula para formato decimal
        function converterCoordenada(valor) {
            if (typeof valor === 'string') {
                // Substituir vírgula por ponto e converter para número
                return parseFloat(valor.replace(',', '.'));
            }
            return parseFloat(valor);
        }

        // Função para listar turnos do GitHub (pastas)
        async function listarTurnosGitHub() {
            try {
                const apiUrl = `https://api.github.com/repos/${USER}/${REPO}/contents`;
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`Erro ao acessar GitHub: ${response.status}`);
                }
                
                const dados = await response.json();
                const turnos = {};
                
                // Processar pastas (turnos)
                for (const item of dados) {
                    if (item.type === 'dir') {
                        const pastaNome = item.name;
                        
                        // Buscar arquivos KML dentro desta pasta
                        const pastaResponse = await fetch(item.url);
                        if (pastaResponse.ok) {
                            const arquivosPasta = await pastaResponse.json();
                            const kmlFiles = arquivosPasta
                                .filter(a => a.name.toLowerCase().endsWith('.kml'))
                                .map(a => a.name);
                            
                            if (kmlFiles.length > 0) {
                                turnos[pastaNome] = kmlFiles;
                            }
                        }
                    }
                }
                
                return turnos;
            } catch (error) {
                console.error('Erro ao listar turnos do GitHub:', error);
                mostrarStatus('Erro ao carregar turnos do GitHub', 'error');
                return {};
            }
        }

        // Função para atualizar o dropdown de rotas
        function atualizarRotasDropdown() {
            const turnoSelecionado = turnoSelect.value;
            
            if (!turnoSelecionado) {
                rotaSelect.innerHTML = '<option value="">Selecione um turno</option>';
                rotaSelect.disabled = true;
                gerarMapaBtn.disabled = true;
                return;
            }
            
            const rotas = turnosData[turnoSelecionado] || [];
            
            if (rotas.length === 0) {
                rotaSelect.innerHTML = '<option value="">Nenhuma rota encontrada</option>';
                rotaSelect.disabled = true;
                gerarMapaBtn.disabled = true;
                mostrarStatus('Nenhuma rota KML encontrada para o turno selecionado', 'warning');
            } else {
                popularSelect(rotaSelect, rotas);
                rotaSelect.disabled = false;
                gerarMapaBtn.disabled = false;
                mostrarStatus(`${rotas.length} rota(s) encontrada(s). Selecione uma para visualizar.`);
            }
        }

        // Função para popular um elemento select com opções
        function popularSelect(selectElement, options) {
            selectElement.innerHTML = '';
            
            if (options.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Nenhuma opção disponível';
                selectElement.appendChild(option);
                return;
            }
            
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                selectElement.appendChild(option);
            });
        }

        // Função principal para gerar o mapa
        async function gerarMapa() {
            const turno = turnoSelect.value;
            const rota = rotaSelect.value;
            
            if (!turno || !rota) {
                mostrarStatus('Selecione um turno e uma rota para gerar o mapa', 'warning');
                return;
            }
            
            mostrarLoading(true, 'Carregando rota e colaboradores...');
            
            try {
                // Limpar layers anteriores
                limparMapa();
                
                // Carregar e exibir KML
                await carregarKML(turno, rota);
                
                // Carregar e exibir colaboradores
                await exibirColaboradoresNoMapa(rota);
                
                // Ajustar a visualização do mapa
                if (colaboradoresBounds.isValid()) {
                    map.fitBounds(colaboradoresBounds, { padding: [50, 50] });
                }
                
                mostrarStatus(`Mapa gerado com sucesso: ${rota}`);
            } catch (error) {
                console.error('Erro ao gerar mapa:', error);
                mostrarStatus('Erro ao gerar mapa. Verifique o console para detalhes.', 'error');
            } finally {
                mostrarLoading(false);
            }
        }

        // Função para carregar e exibir KML do GitHub
        async function carregarKML(turno, rota) {
            try {
                const kmlUrl = `${BASE_URL}${encodeURIComponent(turno)}/${encodeURIComponent(rota)}`;
                const response = await fetch(kmlUrl);
                
                if (!response.ok) {
                    throw new Error(`Erro ao carregar KML: ${response.status}`);
                }
                
                const kmlText = await response.text();
                
                // Criar um parser para processar o KML
                const parser = new DOMParser();
                const kmlDoc = parser.parseFromString(kmlText, 'text/xml');
                
                // Namespace KML
                const ns = {kml: 'http://www.opengis.net/kml/2.2'};
                
                // Extrair Placemarks
                const placemarks = kmlDoc.getElementsByTagName('Placemark');
                const bounds = [];
                
                for (const placemark of placemarks) {
                    // Processar LineStrings (rotas)
                    const lineStrings = placemark.getElementsByTagName('LineString');
                    for (const lineString of lineStrings) {
                        const coordsElement = lineString.getElementsByTagName('coordinates')[0];
                        if (coordsElement) {
                            const coordsText = coordsElement.textContent.trim();
                            const coords = coordsText.split(/\s+/).map(coord => {
                                const [lon, lat] = coord.split(',').map(Number);
                                return [lat, lon];
                            });
                            
                            // Adicionar polyline ao mapa
                            const polyline = L.polyline(coords, {color: 'blue', weight: 4}).addTo(map);
                            currentLayers.push(polyline);
                            
                            // Adicionar coordenadas aos bounds
                            coords.forEach(coord => bounds.push(coord));
                        }
                    }
                    
                    // Processar Points (pontos de interesse)
                    const points = placemark.getElementsByTagName('Point');
                    for (const point of points) {
                        const coordsElement = point.getElementsByTagName('coordinates')[0];
                        if (coordsElement) {
                            const coordsText = coordsElement.textContent.trim();
                            const [lon, lat] = coordsText.split(',').map(Number);
                            
                            // Adicionar marcador ao mapa
                            const marker = L.marker([lat, lon]).addTo(map);
                            currentLayers.push(marker);
                            
                            // Adicionar coordenada aos bounds
                            bounds.push([lat, lon]);
                        }
                    }
                }
                
                // Ajustar visualização do mapa para mostrar toda a rota
                if (bounds.length > 0) {
                    map.fitBounds(bounds, {padding: [20, 20]});
                }
                
            } catch (error) {
                console.error('Erro ao processar KML:', error);
                throw new Error('Falha ao carregar o arquivo KML');
            }
        }

        // Função para exibir colaboradores no mapa
        async function exibirColaboradoresNoMapa(rotaKml) {
            // Remover a extensão .kml para comparar com o CSV
            const rotaBase = rotaKml.replace('.kml', '').replace('.KML', '').trim();
            
            try {
                // Filtrar colaboradores pela rota
                const colaboradoresFiltrados = colaboradoresData.filter(colab => {
                    const colabRota = String(colab.ROTA || '').trim();
                    return colabRota === rotaBase;
                });
                
                if (colaboradoresFiltrados.length === 0) {
                    mostrarStatus(`Nenhum colaborador encontrado para a rota: ${rotaBase}`, 'warning');
                    tabelaColaboradores.innerHTML = '<p class="text-center text-muted">Nenhum colaborador encontrado para esta rota.</p>';
                    return;
                }
                
                // Criar cluster de marcadores
                markerCluster = L.markerClusterGroup({
                    maxClusterRadius: 40,
                    spiderfyOnMaxZoom: true,
                    showCoverageOnHover: true,
                    zoomToBoundsOnClick: true
                });
                
                // Resetar bounds dos colaboradores
                colaboradoresBounds = L.latLngBounds();
                
                // Adicionar marcadores para cada colaborador
                colaboradoresFiltrados.forEach(colab => {
                    // Extrair e converter coordenadas
                    const lat = converterCoordenada(colab.LAT || 0);
                    const lon = converterCoordenada(colab.LONG || 0);
                    
                    // Verificar se as coordenadas são válidas
                    if (isNaN(lat) || isNaN(lon) || lat === 0 || lon === 0) {
                        return;
                    }
                    
                    // Criar marcador
                    const marker = L.marker([lat, lon], {
                        icon: L.divIcon({
                            html: '<i class="fas fa-user" style="color: white; font-size: 12px;"></i>',
                            className: 'colaborador-marker',
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        })
                    });
                    
                    // Popup com informações do colaborador
                    const nome = colab.COLABORADOR || 'N/A';
                    const popupContent = `
                        <div class="info-content">
                            <h5>${nome}</h5>
                            <p><strong>Rota:</strong> ${colab.ROTA || 'N/A'}</p>
                            <p><strong>Coordenadas:</strong> ${lat.toFixed(6)}, ${lon.toFixed(6)}</p>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    markerCluster.addLayer(marker);
                    
                    // Adicionar coordenadas aos bounds
                    colaboradoresBounds.extend([lat, lon]);
                });
                
                // Adicionar cluster ao mapa
                map.addLayer(markerCluster);
                
                // Exibir tabela de colaboradores
                exibirTabelaColaboradores(colaboradoresFiltrados);
                
                mostrarStatus(`${colaboradoresFiltrados.length} colaborador(es) encontrado(s) para a rota ${rotaBase}`);
                
            } catch (error) {
                console.error('Erro ao exibir colaboradores:', error);
                mostrarStatus('Erro ao exibir colaboradores no mapa', 'warning');
            }
        }

        // Função para exibir tabela de colaboradores
        function exibirTabelaColaboradores(colaboradores) {
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Colaborador</th>
                                <th>Latitude</th>
                                <th>Longitude</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            colaboradores.forEach(colab => {
                const lat = converterCoordenada(colab.LAT || 0);
                const lon = converterCoordenada(colab.LONG || 0);
                
                html += `
                    <tr>
                        <td>${colab.COLABORADOR || 'N/A'}</td>
                        <td>${lat.toFixed(6)}</td>
                        <td>${lon.toFixed(6)}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <p class="mt-2"><strong>Total:</strong> ${colaboradores.length} colaborador(es)</p>
            `;
            
            tabelaColaboradores.innerHTML = html;
        }

        // Função para limpar o mapa
        function limparMapa() {
            // Remover layers anteriores
            currentLayers.forEach(layer => {
                map.removeLayer(layer);
            });
            currentLayers = [];
            
            // Remover cluster de marcadores
            if (markerCluster) {
                map.removeLayer(markerCluster);
                markerCluster = null;
            }
            
            // Resetar bounds dos colaboradores
            colaboradoresBounds = L.latLngBounds();
            
            // Limpar tabela de colaboradores
            tabelaColaboradores.innerHTML = '<p class="text-center text-muted">Nenhum colaborador carregado ainda.</p>';
        }

        // Função para mostrar/ocultar loading
        function mostrarLoading(mostrar, mensagem = '') {
            if (mostrar) {
                loadingDiv.style.display = 'flex';
                if (mensagem) {
                    loadingDiv.querySelector('p').textContent = mensagem;
                }
            } else {
                loadingDiv.style.display = 'none';
            }
        }

        // Função para mostrar status
        function mostrarStatus(mensagem, tipo = 'info') {
            statusDiv.textContent = mensagem;
            
            // Cores baseadas no tipo de mensagem
            if (tipo === 'error') {
                statusDiv.style.color = '#dc3545';
            } else if (tipo === 'warning') {
                statusDiv.style.color = '#ffc107';
            } else {
                statusDiv.style.color = '#0d6efd';
            }
        }
    </script>
</body>
</html>