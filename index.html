<script>
// ... (código anterior permanece igual)

// Função para listar turnos do GitHub (pastas)
async function listarTurnosGitHub() {
    try {
        // Para evitar problemas com CORS, vamos usar uma abordagem alternativa
        // Vamos tentar carregar as pastas manualmente
        const turnos = {};
        
        // Lista de pastas que queremos verificar (baseado na estrutura do repositório)
        const pastasParaVerificar = [
            'ADM_IDA', 'ADM_VOLTA', '2T_ESPECIAL_IDA', '2T_ESPECIAL_VOLTA',
            'MANHA_IDA', 'MANHA_VOLTA', 'TARDE_IDA', 'TARDE_VOLTA',
            'NOITE_IDA', 'NOITE_VOLTA'
        ];
        
        // Para cada pasta, tentar carregar um arquivo de exemplo para verificar se existe
        for (const pasta of pastasParaVerificar) {
            try {
                const testUrl = `${BASE_URL}${pasta}/ROTA%20201.kml`; // Testar com um arquivo comum
                const response = await fetch(testUrl, { method: 'HEAD' });
                
                if (response.ok) {
                    // Se a pasta existe, vamos assumir que tem arquivos KML
                    // Em uma implementação real, você listaria os arquivos aqui
                    turnos[pasta] = [
                        'ROTA 201.kml', 'ROTA 202.kml', 'ROTA 203.kml',
                        'ROTA 204.kml', 'ROTA 205.kml', 'ROTA 206.kml'
                    ];
                }
            } catch (e) {
                console.log(`Pasta ${pasta} não encontrada ou sem arquivos:`, e);
                // Tentar verificar se a pasta existe mesmo sem arquivos específicos
                try {
                    const testPastaUrl = `${BASE_URL}${pasta}/`;
                    const responsePasta = await fetch(testPastaUrl, { method: 'HEAD' });
                    if (responsePasta.ok) {
                        turnos[pasta] = ['ROTA 201.kml', 'ROTA 202.kml']; // Arquivos genéricos
                    }
                } catch (err) {
                    console.log(`Pasta ${pasta} não existe:`, err);
                }
            }
        }
        
        // Se nenhuma pasta for encontrada, usar dados de exemplo
        if (Object.keys(turnos).length === 0) {
            console.log('Nenhuma pasta encontrada, usando dados de exemplo');
            return {
                'ADM_IDA': ['ROTA 201.kml', 'ROTA 202.kml', 'ROTA 203.kml'],
                'ADM_VOLTA': ['ROTA 201.kml', 'ROTA 202.kml', 'ROTA 203.kml'],
                '2T_ESPECIAL_IDA': ['ROTA 301.kml', 'ROTA 302.kml'],
                '2T_ESPECIAL_VOLTA': ['ROTA 301.kml', 'ROTA 302.kml']
            };
        }
        
        return turnos;
        
    } catch (error) {
        console.error('Erro ao listar turnos do GitHub:', error);
        
        // Fallback: retornar dados de exemplo se a API falhar
        mostrarStatus('Usando dados de exemplo para turnos', 'warning');
        return {
            'ADM_IDA': ['ROTA 201.kml', 'ROTA 202.kml', 'ROTA 203.kml'],
            'ADM_VOLTA': ['ROTA 201.kml', 'ROTA 202.kml', 'ROTA 203.kml'],
            '2T_ESPECIAL_IDA': ['ROTA 301.kml', 'ROTA 302.kml'],
            '2T_ESPECIAL_VOLTA': ['ROTA 301.kml', 'ROTA 302.kml'],
            'MANHA_IDA': ['ROTA 101.kml', 'ROTA 102.kml'],
            'MANHA_VOLTA': ['ROTA 101.kml', 'ROTA 102.kml']
        };
    }
}

// Função para atualizar o dropdown de rotas
function atualizarRotasDropdown(turnoSelectElement, rotaSelectElement) {
    const turnoSelecionado = turnoSelectElement.value;
    const isPerimetro = turnoSelectElement === turnoPerimetroSelect;
    const direcao = isPerimetro ? direcaoPerimetroSelecionada : direcaoSelecionada;
    
    if (!turnoSelecionado) {
        rotaSelectElement.innerHTML = '<option value="">Selecione um turno</option>';
        rotaSelectElement.disabled = true;
        if (rotaSelectElement === rotaSelect) {
            gerarMapaBtn.disabled = true;
        }
        return;
    }
    
    // Obter rotas do turno selecionado
    const rotas = turnosData[turnoSelecionado] || [];
    
    if (rotas.length === 0) {
        rotaSelectElement.innerHTML = '<option value="">Nenhuma rota encontrada</option>';
        rotaSelectElement.disabled = true;
        if (rotaSelectElement === rotaSelect) {
            gerarMapaBtn.disabled = true;
        }
        mostrarStatus(`Nenhuma rota encontrada para o turno selecionado`, 'warning');
    } else {
        popularSelectMultiplo(rotaSelectElement, rotas);
        rotaSelectElement.disabled = false;
        if (rotaSelectElement === rotaSelect) {
            gerarMapaBtn.disabled = false;
        }
        mostrarStatus(`${rotas.length} rota(s) encontrada(s). Selecione uma para visualizar.`);
    }
}

// Função para atualizar o dropdown de turnos baseado na direção selecionada
function atualizarTurnosDropdown() {
    const turnosFiltrados = Object.keys(turnosData).filter(turno => {
        if (direcaoSelecionada === 'IDA') {
            return turno.includes('IDA');
        } else {
            return turno.includes('VOLTA');
        }
    });
    
    popularSelect(turnoSelect, turnosFiltrados);
    popularSelect(turnoPerimetroSelect, turnosFiltrados);
    
    if (turnosFiltrados.length === 0) {
        mostrarStatus(`Nenhum turno encontrado para direção ${direcaoSelecionada}`, 'warning');
    } else {
        mostrarStatus(`${turnosFiltrados.length} turno(s) ${direcaoSelecionada} encontrado(s)`);
    }
}

// Função para selecionar direção (IDA/VOLTA)
function selecionarDirecao(direcao, btnAtivo, btnInativo) {
    direcaoSelecionada = direcao;
    btnAtivo.classList.add('active');
    btnInativo.classList.remove('active');
    atualizarTurnosDropdown();
}

// Função para selecionar direção no painel de perímetro (IDA/VOLTA)
function selecionarDirecaoPerimetro(direcao, btnAtivo, btnInativo) {
    direcaoPerimetroSelecionada = direcao;
    btnAtivo.classList.add('active');
    btnInativo.classList.remove('active');
    
    // Atualizar também os turnos do painel de perímetro
    const turnosFiltrados = Object.keys(turnosData).filter(turno => {
        if (direcao === 'IDA') {
            return turno.includes('IDA');
        } else {
            return turno.includes('VOLTA');
        }
    });
    
    popularSelect(turnoPerimetroSelect, turnosFiltrados);
}

// ... (restante do código permanece igual)
</script>